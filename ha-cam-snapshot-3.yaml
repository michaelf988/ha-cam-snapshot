blueprint:
  name: "Camera Event Notification 3.6.0"
  author: "MF"
  homeassistant:
    min_version: 2024.10.0
  description: >
    Szenario-basierte Kamera-Überwachung mit intelligenter Personen-Erkennung.
    Features: 3-stufige Wichtigkeitsanalyse, Video-Verifikation mit Retry bei "Unklar",
    dynamische Level-Anpassung, 7 individuell konfigurierbare Szenarien (inkl. 4a), 
    LG WebOS TV Support, TTS-Ansagen bei kritischen Events.
    Automatische Szenario-Erkennung mit Helper-Override für Szenario 6.
    
    HINWEIS: Video-Aufnahmen verbrauchen mehr Speicherplatz als Snapshots.
    Stellen Sie sicher, dass ausreichend Speicherplatz verfügbar ist und
    ggf. eine automatische Bereinigung alter Aufnahmen eingerichtet ist.

  domain: automation
  source_url: https://github.com/michaelf988/ha-cam-snapshot/blob/main/ha-cam-snapshot-new.yaml

# =======================
# CHANGELOG
# =======================
# 3.6.0: Separate Snapshot/Video-Steuerung & Neues Szenario 4a
#        - Snapshot und Video-Aufnahme pro Szenario separat steuerbar
#        - Hinweis: Video-Analyse benötigt aktivierte Video-Aufnahme
#        - Neues Szenario 4a: Abwesend, Alarmanlage extern scharf, tagsüber
#        - Szenario 4 umbenannt: Abwesend, Alarmanlage extern scharf, spät abends
#        - Insgesamt 7 Szenarien (1, 2, 3, 4, 4a, 5, 6)
# 3.5.0: Video-Analyse & Parallele Aufnahme
#        - Modul 1: Parallele Ausführung von Snapshot und Video-Aufnahme
#        - Modul 5: Umstellung auf llmvision.video_analyzer
#        - Unterschiedliche Töne/Lautstärke für normal vs. critical Push
# 3.4.4: Update-Push mit Wiederholungen (count + for_each)
# 3.4.3: TTS Condition Fix & Update-Push Wiederherstellung
# 3.4.0: Alarm-Wiederholungen Umstrukturierung & TTS Fix
# 3.3.0: Überarbeitete Benachrichtigungstexte und Debug-Schalter
# 3.1.0: Stream-Analyse Retry bei "Unklar"
# 3.0.0: Kompletter Umbau des Detection-Systems

  input:
    # =======================
    # 1. KAMERAS & SENSOREN
    # =======================
    cameras_section:
      name: "Kameras & Sensoren"
      description: "Kamera- und Bewegungsmelder-Einstellungen"
      icon: mdi:camera
      collapsed: true
      input:
        camera_entities:
          name: "Camera Entities"
          description: "Eine oder mehrere Kameras"
          selector:
            entity:
              multiple: true
              filter:
                domain: camera

        trigger_state:
          name: "Trigger State"
          description: "Automation startet, wenn Kamera in diesen Zustand wechselt"
          default: "recording"
          selector:
            text:

        motion_sensors:
          name: "Motion Sensors (optional)"
          description: "Alternative Bewegungsmelder, Reihenfolge = Kamera-Reihenfolge"
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain: binary_sensor

    # =======================
    # 2. SPEICHERUNG
    # =======================
    storage_section:
      name: "Speicherung"
      description: "Dateipfade und Snapshot-Einstellungen. HINWEIS: Videos verbrauchen mehr Speicherplatz."
      icon: mdi:folder
      collapsed: true
      input:
        timestamp_filenames:
          name: "Zeitstempel-Dateinamen"
          description: "Speichert als YYYY-MM-DD_HH-MM-SS.jpg/.mp4"
          default: true
          selector:
            boolean:
            
        timestamp_format:
          name: "Zeitstempel-Format"
          default: "%Y-%m-%d_%H-%M-%S"
          selector:
            text:

        snapshot_dir_fs:
          name: "Basis-Pfad (Dateisystem)"
          description: "z.B. /config/www/snapshots"
          default: "/config/www/snapshots"
          selector:
            text:
            
        snapshot_dir_web:
          name: "Basis-Pfad (Web)"
          description: "z.B. /local/snapshots"
          default: "/local/snapshots"
          selector:
            text:

    # =======================
    # 3. AI GRUNDEINSTELLUNGEN
    # =======================
    ai_base_section:
      name: "AI Grundeinstellungen"
      description: "Provider, Model und allgemeine AI-Parameter"
      icon: mdi:brain
      collapsed: true
      input:
        provider:
          name: "AI Provider"
          description: "LLMVision Provider für Analysen"
          selector:
            config_entry:
              integration: llmvision

        model:
          name: "AI Model"
          default: "gpt-4o-mini"
          selector:
            text:

    # =======================
    # 3a. VIDEO-AUFNAHME EINSTELLUNGEN
    # =======================
    video_recording_section:
      name: "Video-Aufnahme Einstellungen"
      description: "Parameter für die Video-Aufnahme (camera.record) - wird parallel zum Snapshot erstellt"
      icon: mdi:video
      collapsed: true
      input:
        video_duration:
          name: "Video-Dauer (Sekunden)"
          description: "Wie lange das Video aufgenommen werden soll"
          default: 5
          selector:
            number:
              min: 1
              max: 30
              unit_of_measurement: seconds

        video_lookback:
          name: "Video-Rückblick (Sekunden)"
          description: "Wie viele Sekunden vor dem Trigger einbezogen werden (erfordert aktiven HLS-Stream)"
          default: 5
          selector:
            number:
              min: 0
              max: 30
              unit_of_measurement: seconds

    # =======================
    # 3b. WICHTIGKEITS-ANALYSE (MODUL 2)
    # =======================
    importance_analysis_section:
      name: "Wichtigkeits-Analyse (Snapshot)"
      description: "Parameter für die initiale Bildanalyse zur Erkennung von Personen"
      icon: mdi:image-search
      collapsed: true
      input:
        importance_target_width:
          name: "Bild-Breite (Pixel)"
          description: "Breite für die Bildanalyse"
          default: 1280
          selector:
            number:
              min: 512
              max: 3840

        importance_max_tokens:
          name: "Max Tokens"
          description: "Maximale Anzahl der Antwort-Tokens"
          default: 4000
          selector:
            number:
              min: 1
              max: 15000

        importance_max_retries:
          name: "Max Versuche"
          description: "Wie oft bei ungültiger Antwort wiederholt werden soll (1 = kein Retry)"
          default: 2
          selector:
            number:
              min: 1
              max: 5

        importance_retry_delay:
          name: "Pause zwischen Versuchen"
          default: { seconds: 1 }
          selector:
            duration: {}

        importance_prompt:
          name: "Wichtigkeits-Analyse Prompt"
          description: "Muss eines zurückgeben: no-person, probably-person, definitely-person"
          default: >
            CONTEXT: Security camera snapshot from a private property surveillance system.
            Current time: {{ now().strftime('%H:%M') }}
            
            TASK: Analyze this single frame for human presence.
            
            CLASSIFICATION (return ONLY one of these labels):
            - "no-person" = No human detected, no security concern
            - "probably-person" = Unclear, possibly a person, shadows or partial view
            - "definitely-person" = Clear human presence detected
            
            Consider: Body shape, movement patterns typical of humans, size relative to environment.
            Ignore: Pets, vehicles (unless person visible inside), shadows without clear human form.
            
            RESPONSE: One label only.
          selector:
            text:
              multiline: true

    # =======================
    # 3c. VIDEO-ANALYSE (MODUL 5)
    # =======================
    video_analysis_section:
      name: "Video-Analyse (Verifikation)"
      description: "Parameter für die Video-Analyse zur Verifikation der Ersterkennung"
      icon: mdi:video-check
      collapsed: true
      input:
        video_target_width:
          name: "Bild-Breite (Pixel)"
          description: "Breite für die Video-Frame-Analyse"
          default: 1280
          selector:
            number:
              min: 512
              max: 3840

        video_max_frames:
          name: "Max Frames"
          description: "Anzahl der zu analysierenden Frames (wählt die mit meister Bewegung)"
          default: 3
          selector:
            number:
              min: 1
              max: 10

        video_max_tokens:
          name: "Max Tokens"
          description: "Maximale Anzahl der Antwort-Tokens"
          default: 5000
          selector:
            number:
              min: 1
              max: 15000

        video_max_retries:
          name: "Max Versuche"
          description: "Wie oft bei 'Unklar' wiederholt werden soll (1 = kein Retry)"
          default: 3
          selector:
            number:
              min: 1
              max: 10

        video_retry_delay:
          name: "Pause zwischen Versuchen"
          default: { seconds: 2 }
          selector:
            duration: {}

        video_prompt:
          name: "Video-Analyse Prompt"
          default: >
            CONTEXT: Security camera video recording from private property.
            Current time: {{ now().strftime('%H:%M') }}
            
            TASK: Identify the primary subject of movement/activity.
            
            RESPONSE OPTIONS (choose most relevant):
            - "Person erkannt" = Single person visible
            - "Mehrere Personen" = Multiple people visible
            - "Fahrzeug erkannt" = Vehicle detected
            - "Tier erkannt" = Animal detected
            - "Person und Fahrzeug" = Both person and vehicle
            - "Unklar" = Movement detected but subject unclear
            - "Keine Bewegung" = No significant movement
            
            RESPONSE: One phrase only from the list above.
          selector:
            text:
              multiline: true

    # =======================
    # 4. TTS GRUNDEINSTELLUNGEN
    # =======================
    tts_base_section:
      name: "Text-to-Speech Grundeinstellungen"
      description: "Sprachausgabe-Konfiguration (nur bei kritischen Events)"
      icon: mdi:volume-high
      collapsed: true
      input:
        tts_target_entity:
          name: "TTS Service"
          description: "z.B. tts.home_assistant_cloud"
          selector:
            entity:
              filter:
                domain: tts

        tts_media_players:
          name: "Lautsprecher für TTS"
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain: media_player

        tts_volume:
          name: "TTS Lautstärke"
          default: 0.7
          selector:
            number:
              min: 0
              max: 1
              step: 0.05

        tts_repeat_count:
          name: "TTS Wiederholungen"
          default: 3
          selector:
            number:
              min: 1
              max: 10

        tts_repeat_delay:
          name: "Pause zwischen Wiederholungen"
          default: { seconds: 2 }
          selector:
            duration: {}

    # =======================
    # 5. MOBILE BENACHRICHTIGUNGEN
    # =======================
    mobile_notifications_section:
      name: "Mobile Benachrichtigungen"
      description: "iOS/Android Companion App Einstellungen"
      icon: mdi:cellphone
      collapsed: true
      input:
        notify_device:
          name: "Mobile Geräte"
          selector:
            device:
              multiple: true
              filter:
                integration: mobile_app

        tap_navigate:
          name: "Tap / Click Action Path"
          description: "Pfad beim Antippen der Benachrichtigung"
          default: "/lovelace/cameras"
          selector:
            text:

        notification_time:
          name: "Zeit im Titel"
          default: ""
          selector:
            select:
              options:
                - label: "Keine Zeit"
                  value: ""
                - label: "Mit Uhrzeit"
                  value: "um {{ now().strftime('%H:%M') }}"

        delay_notification:
          name: "Cooldown zwischen Benachrichtigungen"
          description: "Verhindert Spam bei mehrfachen Triggern"
          default: 15
          selector:
            number:
              min: 0
              max: 600
              unit_of_measurement: seconds

        alarm_repetition_count:
          name: "Alarm-Wiederholungen (wenn aktiv)"
          default: 5
          selector:
            number:
              min: 1
              max: 20

        alarm_repetition_delay:
          name: "Pause zwischen Alarm-Wiederholungen"
          default: { seconds: 3 }
          selector:
            duration: {}

    # =======================
    # 5a. BENACHRICHTIGUNGSTÖNE
    # =======================
    notification_sounds_section:
      name: "Benachrichtigungstöne"
      description: "Unterschiedliche Töne und Lautstärken für normale und kritische Benachrichtigungen"
      icon: mdi:bell-ring
      collapsed: true
      input:
        notification_sound:
          name: "Ton (Normal: passive/active/time-sensitive)"
          description: "Benachrichtigungston für nicht-kritische Events"
          default: "LiquidDetected.caf"
          selector:
            text:

        notification_volume:
          name: "Lautstärke (Normal)"
          description: "Lautstärke für nicht-kritische Events"
          default: 0.7
          selector:
            number:
              min: 0
              max: 1
              step: 0.1

        notification_sound_critical:
          name: "Ton (Critical)"
          description: "Benachrichtigungston für kritische Events"
          default: "alarm.caf"
          selector:
            text:

        notification_volume_critical:
          name: "Lautstärke (Critical)"
          description: "Lautstärke für kritische Events"
          default: 1.0
          selector:
            number:
              min: 0
              max: 1
              step: 0.1

    # =======================
    # 5b. ACTION BUTTONS
    # =======================
    action_buttons_section:
      name: "Action Buttons"
      description: "Konfigurierbare Buttons in Push-Benachrichtigungen"
      icon: mdi:gesture-tap-button
      collapsed: true
      input:
        action1_enabled:
          name: "Button 1 aktivieren"
          default: true
          selector:
            boolean:
        action1_title:
          name: "Button 1 Text"
          default: "Öffnen"
          selector:
            text:
        action1_uri:
          name: "Button 1 URI (optional)"
          default: ""
          selector:
            text:
        action1_icon:
          name: "Button 1 Icon (optional)"
          description: "iOS SF Symbol, z.B. sfsymbols:bell"
          default: ""
          selector:
            text:
        action1_destructive:
          name: "Button 1 Rot markieren"
          default: false
          selector:
            boolean:

        action2_enabled:
          name: "Button 2 aktivieren"
          default: true
          selector:
            boolean:
        action2_title:
          name: "Button 2 Text"
          default: "Snooze 15min"
          selector:
            text:
        action2_uri:
          name: "Button 2 URI (optional)"
          default: ""
          selector:
            text:
        action2_icon:
          name: "Button 2 Icon (optional)"
          default: ""
          selector:
            text:
        action2_destructive:
          name: "Button 2 Rot markieren"
          default: false
          selector:
            boolean:

        action3_enabled:
          name: "Button 3 aktivieren"
          default: false
          selector:
            boolean:
        action3_title:
          name: "Button 3 Text"
          default: "Alarm aus"
          selector:
            text:
        action3_uri:
          name: "Button 3 URI (optional)"
          default: ""
          selector:
            text:
        action3_icon:
          name: "Button 3 Icon (optional)"
          default: ""
          selector:
            text:
        action3_destructive:
          name: "Button 3 Rot markieren"
          default: true
          selector:
            boolean:

    # =======================
    # 6. TV & WEITERE GERÄTE
    # =======================
    additional_notifications_section:
      name: "TV & weitere Benachrichtigungen"
      description: "Nicht-mobile Benachrichtigungsgeräte"
      icon: mdi:television
      collapsed: true
      input:
        lg_tv_enable:
          name: "LG WebOS TV Benachrichtigungen"
          description: "Sendet Nachrichten an LG TV via notify.lg_webos_smart_tv"
          default: false
          selector:
            boolean:

        lg_tv_conditions:
          name: "Bedingungen für LG TV-Benachrichtigungen"
          default: []
          selector:
            condition:

        lg_tv_message_title:
          name: "LG TV Nachricht Titel"
          default: "Sicherheitswarnung"
          selector:
            text:

        other_notify_entities:
          name: "Weitere Notify Services (optional)"
          description: "z.B. andere Smart TVs, Alexa, etc."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain: notify

        other_notify_conditions:
          name: "Bedingungen für weitere Benachrichtigungen"
          default: []
          selector:
            condition:

        other_notify_title:
          name: "Weitere Services - Titel"
          default: "Sicherheitswarnung"
          selector:
            text:

    # =======================
    # 7. SZENARIO-STEUERUNG
    # =======================
    scenario_control_section:
      name: "Szenario-Steuerung"
      description: "Automatische Szenario-Erkennung mit Helper-Override"
      icon: mdi:home-automation
      collapsed: false
      input:
        scenario_helper:
          name: "Szenario 6 Helper Entity"
          description: "Wenn aktiv, wird immer Szenario 6 verwendet"
          default: "input_boolean.cam_event_notify_helper"
          selector:
            entity:
              filter:
                domain: input_boolean

        scenario_fallback:
          name: "Fallback Szenario"
          description: "Wenn keine Bedingung zutrifft"
          default: "3"
          selector:
            select:
              options:
                - label: "Szenario 1"
                  value: "1"
                - label: "Szenario 2"
                  value: "2"
                - label: "Szenario 3 (Minimal)"
                  value: "3"
                - label: "Szenario 4"
                  value: "4"
                - label: "Szenario 4a"
                  value: "4a"
                - label: "Szenario 5"
                  value: "5"
                - label: "Szenario 6"
                  value: "6"

    # =======================
    # SZENARIO 1
    # =======================
    scenario_1_section:
      name: "Szenario 1: Anwesend, Alarmanlage intern scharf"
      description: "Höchste Sicherheit bei Anwesenheit"
      icon: mdi:shield-home
      collapsed: true
      input:
        s1_conditions:
          name: "Aktivierungsbedingungen"
          default: []
          selector:
            condition:

        s1_snapshot:
          name: "Snapshot erstellen"
          description: "Erstellt ein Standbild bei Bewegungserkennung"
          default: true
          selector:
            boolean:

        s1_video:
          name: "Video aufnehmen"
          description: "⚠️ WICHTIG: Muss aktiviert sein, wenn Video-Analyse genutzt werden soll!"
          default: true
          selector:
            boolean:

        s1_importance_check:
          name: "Wichtigkeitsanalyse"
          default: true
          selector:
            boolean:

        s1_level_no_person:
          name: "Level bei: Keine Person"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s1_level_probably_person:
          name: "Level bei: Wahrscheinlich Person"
          default: "time-sensitive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s1_level_definitely_person:
          name: "Level bei: Definitiv Person"
          default: "critical"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s1_gate_enable:
          name: "Gate aktivieren"
          default: true
          selector:
            boolean:

        s1_gate_threshold:
          name: "Gate Schwellwert"
          default: "passive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s1_mobile_push:
          name: "Mobile Push"
          default: true
          selector:
            boolean:

        s1_video_min_detection:
          name: "Video-Analyse ab Detection-Level"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme!"
          default: "probably-person"
          selector:
            select:
              options:
                - label: "Immer"
                  value: "always"
                - label: "Ab: Keine Person"
                  value: "no-person"
                - label: "Ab: Wahrscheinlich Person"
                  value: "probably-person"
                - label: "Ab: Definitiv Person"
                  value: "definitely-person"
                - label: "Nie"
                  value: "never"

        s1_tv_notify:
          name: "TV Benachrichtigung"
          default: false
          selector:
            boolean:

        s1_tts_enable:
          name: "Sprachansage (nur bei Critical)"
          default: true
          selector:
            boolean:

        s1_tts_conditions:
          name: "Zusätzliche TTS-Bedingungen"
          default: []
          selector:
            condition:

        s1_alarm_mode:
          name: "Alarm-Wiederholungen"
          default: true
          selector:
            boolean:

        s1_update_push:
          name: "Update-Push nach Video-Analyse"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme und Video-Analyse!"
          default: true
          selector:
            boolean:

    # =======================
    # SZENARIO 2
    # =======================
    scenario_2_section:
      name: "Szenario 2: Anwesend, spät abends, unscharf"
      description: "Erhöhte Aufmerksamkeit am Abend"
      icon: mdi:weather-night
      collapsed: true
      input:
        s2_conditions:
          name: "Aktivierungsbedingungen"
          default: []
          selector:
            condition:

        s2_snapshot:
          name: "Snapshot erstellen"
          description: "Erstellt ein Standbild bei Bewegungserkennung"
          default: true
          selector:
            boolean:

        s2_video:
          name: "Video aufnehmen"
          description: "⚠️ WICHTIG: Muss aktiviert sein, wenn Video-Analyse genutzt werden soll!"
          default: true
          selector:
            boolean:

        s2_importance_check:
          name: "Wichtigkeitsanalyse"
          default: true
          selector:
            boolean:

        s2_level_no_person:
          name: "Level bei: Keine Person"
          default: "passive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s2_level_probably_person:
          name: "Level bei: Wahrscheinlich Person"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s2_level_definitely_person:
          name: "Level bei: Definitiv Person"
          default: "time-sensitive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s2_gate_enable:
          name: "Gate aktivieren"
          default: true
          selector:
            boolean:

        s2_gate_threshold:
          name: "Gate Schwellwert"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s2_mobile_push:
          name: "Mobile Push"
          default: true
          selector:
            boolean:

        s2_video_min_detection:
          name: "Video-Analyse ab Detection-Level"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme!"
          default: "definitely-person"
          selector:
            select:
              options:
                - label: "Immer"
                  value: "always"
                - label: "Ab: Keine Person"
                  value: "no-person"
                - label: "Ab: Wahrscheinlich Person"
                  value: "probably-person"
                - label: "Ab: Definitiv Person"
                  value: "definitely-person"
                - label: "Nie"
                  value: "never"

        s2_tv_notify:
          name: "TV Benachrichtigung"
          default: true
          selector:
            boolean:

        s2_tts_enable:
          name: "Sprachansage (nur bei Critical)"
          default: false
          selector:
            boolean:

        s2_tts_conditions:
          name: "Zusätzliche TTS-Bedingungen"
          default: []
          selector:
            condition:

        s2_alarm_mode:
          name: "Alarm-Wiederholungen"
          default: false
          selector:
            boolean:

        s2_update_push:
          name: "Update-Push nach Video-Analyse"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme und Video-Analyse!"
          default: false
          selector:
            boolean:

    # =======================
    # SZENARIO 3
    # =======================
    scenario_3_section:
      name: "Szenario 3: Anwesend, tagsüber, unscharf"
      description: "Minimale Überwachung tagsüber"
      icon: mdi:weather-sunny
      collapsed: true
      input:
        s3_conditions:
          name: "Aktivierungsbedingungen"
          default: []
          selector:
            condition:

        s3_snapshot:
          name: "Snapshot erstellen"
          description: "Erstellt ein Standbild bei Bewegungserkennung"
          default: true
          selector:
            boolean:

        s3_video:
          name: "Video aufnehmen"
          description: "⚠️ WICHTIG: Muss aktiviert sein, wenn Video-Analyse genutzt werden soll!"
          default: false
          selector:
            boolean:

        s3_importance_check:
          name: "Wichtigkeitsanalyse"
          default: false
          selector:
            boolean:

        s3_level_no_person:
          name: "Level bei: Keine Person"
          default: "passive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s3_level_probably_person:
          name: "Level bei: Wahrscheinlich Person"
          default: "passive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s3_level_definitely_person:
          name: "Level bei: Definitiv Person"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s3_gate_enable:
          name: "Gate aktivieren"
          default: false
          selector:
            boolean:

        s3_gate_threshold:
          name: "Gate Schwellwert"
          default: "time-sensitive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s3_mobile_push:
          name: "Mobile Push"
          default: true
          selector:
            boolean:

        s3_video_min_detection:
          name: "Video-Analyse ab Detection-Level"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme!"
          default: "never"
          selector:
            select:
              options:
                - label: "Immer"
                  value: "always"
                - label: "Ab: Keine Person"
                  value: "no-person"
                - label: "Ab: Wahrscheinlich Person"
                  value: "probably-person"
                - label: "Ab: Definitiv Person"
                  value: "definitely-person"
                - label: "Nie"
                  value: "never"

        s3_tv_notify:
          name: "TV Benachrichtigung"
          default: true
          selector:
            boolean:

        s3_tts_enable:
          name: "Sprachansage (nur bei Critical)"
          default: false
          selector:
            boolean:

        s3_tts_conditions:
          name: "Zusätzliche TTS-Bedingungen"
          default: []
          selector:
            condition:

        s3_alarm_mode:
          name: "Alarm-Wiederholungen"
          default: false
          selector:
            boolean:

        s3_update_push:
          name: "Update-Push nach Video-Analyse"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme und Video-Analyse!"
          default: false
          selector:
            boolean:

    # =======================
    # SZENARIO 4
    # =======================
    scenario_4_section:
      name: "Szenario 4: Abwesend, Alarmanlage extern scharf, spät abends"
      description: "Maximale Sicherheit bei Abwesenheit am Abend"
      icon: mdi:shield-lock
      collapsed: true
      input:
        s4_conditions:
          name: "Aktivierungsbedingungen"
          default: []
          selector:
            condition:

        s4_snapshot:
          name: "Snapshot erstellen"
          description: "Erstellt ein Standbild bei Bewegungserkennung"
          default: true
          selector:
            boolean:

        s4_video:
          name: "Video aufnehmen"
          description: "⚠️ WICHTIG: Muss aktiviert sein, wenn Video-Analyse genutzt werden soll!"
          default: true
          selector:
            boolean:

        s4_importance_check:
          name: "Wichtigkeitsanalyse"
          default: true
          selector:
            boolean:

        s4_level_no_person:
          name: "Level bei: Keine Person"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s4_level_probably_person:
          name: "Level bei: Wahrscheinlich Person"
          default: "time-sensitive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s4_level_definitely_person:
          name: "Level bei: Definitiv Person"
          default: "critical"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s4_gate_enable:
          name: "Gate aktivieren"
          default: true
          selector:
            boolean:

        s4_gate_threshold:
          name: "Gate Schwellwert"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s4_mobile_push:
          name: "Mobile Push"
          default: true
          selector:
            boolean:

        s4_video_min_detection:
          name: "Video-Analyse ab Detection-Level"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme!"
          default: "no-person"
          selector:
            select:
              options:
                - label: "Immer"
                  value: "always"
                - label: "Ab: Keine Person"
                  value: "no-person"
                - label: "Ab: Wahrscheinlich Person"
                  value: "probably-person"
                - label: "Ab: Definitiv Person"
                  value: "definitely-person"
                - label: "Nie"
                  value: "never"

        s4_tv_notify:
          name: "TV Benachrichtigung"
          default: false
          selector:
            boolean:

        s4_tts_enable:
          name: "Sprachansage (nur bei Critical)"
          default: false
          selector:
            boolean:

        s4_tts_conditions:
          name: "Zusätzliche TTS-Bedingungen"
          default: []
          selector:
            condition:

        s4_alarm_mode:
          name: "Alarm-Wiederholungen"
          default: true
          selector:
            boolean:

        s4_alarm_conditions:
          name: "Zusätzliche Alarm-Bedingungen"
          default: []
          selector:
            condition:

        s4_update_push:
          name: "Update-Push nach Video-Analyse"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme und Video-Analyse!"
          default: true
          selector:
            boolean:

    # =======================
    # SZENARIO 4a
    # =======================
    scenario_4a_section:
      name: "Szenario 4a: Abwesend, Alarmanlage extern scharf, tagsüber"
      description: "Maximale Sicherheit bei Abwesenheit tagsüber"
      icon: mdi:shield-sun
      collapsed: true
      input:
        s4a_conditions:
          name: "Aktivierungsbedingungen"
          default: []
          selector:
            condition:

        s4a_snapshot:
          name: "Snapshot erstellen"
          description: "Erstellt ein Standbild bei Bewegungserkennung"
          default: true
          selector:
            boolean:

        s4a_video:
          name: "Video aufnehmen"
          description: "⚠️ WICHTIG: Muss aktiviert sein, wenn Video-Analyse genutzt werden soll!"
          default: true
          selector:
            boolean:

        s4a_importance_check:
          name: "Wichtigkeitsanalyse"
          default: true
          selector:
            boolean:

        s4a_level_no_person:
          name: "Level bei: Keine Person"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s4a_level_probably_person:
          name: "Level bei: Wahrscheinlich Person"
          default: "time-sensitive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s4a_level_definitely_person:
          name: "Level bei: Definitiv Person"
          default: "critical"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s4a_gate_enable:
          name: "Gate aktivieren"
          default: true
          selector:
            boolean:

        s4a_gate_threshold:
          name: "Gate Schwellwert"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s4a_mobile_push:
          name: "Mobile Push"
          default: true
          selector:
            boolean:

        s4a_video_min_detection:
          name: "Video-Analyse ab Detection-Level"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme!"
          default: "no-person"
          selector:
            select:
              options:
                - label: "Immer"
                  value: "always"
                - label: "Ab: Keine Person"
                  value: "no-person"
                - label: "Ab: Wahrscheinlich Person"
                  value: "probably-person"
                - label: "Ab: Definitiv Person"
                  value: "definitely-person"
                - label: "Nie"
                  value: "never"

        s4a_tv_notify:
          name: "TV Benachrichtigung"
          default: false
          selector:
            boolean:

        s4a_tts_enable:
          name: "Sprachansage (nur bei Critical)"
          default: false
          selector:
            boolean:

        s4a_tts_conditions:
          name: "Zusätzliche TTS-Bedingungen"
          default: []
          selector:
            condition:

        s4a_alarm_mode:
          name: "Alarm-Wiederholungen"
          default: true
          selector:
            boolean:

        s4a_alarm_conditions:
          name: "Zusätzliche Alarm-Bedingungen"
          default: []
          selector:
            condition:

        s4a_update_push:
          name: "Update-Push nach Video-Analyse"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme und Video-Analyse!"
          default: true
          selector:
            boolean:

    # =======================
    # SZENARIO 5
    # =======================
    scenario_5_section:
      name: "Szenario 5: Abwesend, Alarmanlage nicht scharf"
      description: "Basis-Überwachung ohne Alarm"
      icon: mdi:home-outline
      collapsed: true
      input:
        s5_conditions:
          name: "Aktivierungsbedingungen"
          default: []
          selector:
            condition:

        s5_snapshot:
          name: "Snapshot erstellen"
          description: "Erstellt ein Standbild bei Bewegungserkennung"
          default: true
          selector:
            boolean:

        s5_video:
          name: "Video aufnehmen"
          description: "⚠️ WICHTIG: Muss aktiviert sein, wenn Video-Analyse genutzt werden soll!"
          default: true
          selector:
            boolean:

        s5_importance_check:
          name: "Wichtigkeitsanalyse"
          default: true
          selector:
            boolean:

        s5_level_no_person:
          name: "Level bei: Keine Person"
          default: "passive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s5_level_probably_person:
          name: "Level bei: Wahrscheinlich Person"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s5_level_definitely_person:
          name: "Level bei: Definitiv Person"
          default: "time-sensitive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s5_gate_enable:
          name: "Gate aktivieren"
          default: false
          selector:
            boolean:

        s5_gate_threshold:
          name: "Gate Schwellwert"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s5_mobile_push:
          name: "Mobile Push"
          default: true
          selector:
            boolean:

        s5_video_min_detection:
          name: "Video-Analyse ab Detection-Level"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme!"
          default: "probably-person"
          selector:
            select:
              options:
                - label: "Immer"
                  value: "always"
                - label: "Ab: Keine Person"
                  value: "no-person"
                - label: "Ab: Wahrscheinlich Person"
                  value: "probably-person"
                - label: "Ab: Definitiv Person"
                  value: "definitely-person"
                - label: "Nie"
                  value: "never"

        s5_tv_notify:
          name: "TV Benachrichtigung"
          default: false
          selector:
            boolean:

        s5_tts_enable:
          name: "Sprachansage (nur bei Critical)"
          default: false
          selector:
            boolean:

        s5_tts_conditions:
          name: "Zusätzliche TTS-Bedingungen"
          default: []
          selector:
            condition:

        s5_alarm_mode:
          name: "Alarm-Wiederholungen"
          default: false
          selector:
            boolean:

        s5_update_push:
          name: "Update-Push nach Video-Analyse"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme und Video-Analyse!"
          default: false
          selector:
            boolean:

    # =======================
    # SZENARIO 6
    # =======================
    scenario_6_section:
      name: "Szenario 6: Manueller Modus"
      description: "Aktiviert wenn Helper Entity an ist"
      icon: mdi:hand-pointing-right
      collapsed: true
      input:
        s6_conditions:
          name: "Zusätzliche Aktivierungsbedingungen"
          default: []
          selector:
            condition:

        s6_snapshot:
          name: "Snapshot erstellen"
          description: "Erstellt ein Standbild bei Bewegungserkennung"
          default: true
          selector:
            boolean:

        s6_video:
          name: "Video aufnehmen"
          description: "⚠️ WICHTIG: Muss aktiviert sein, wenn Video-Analyse genutzt werden soll!"
          default: true
          selector:
            boolean:

        s6_importance_check:
          name: "Wichtigkeitsanalyse"
          default: true
          selector:
            boolean:

        s6_level_no_person:
          name: "Level bei: Keine Person"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s6_level_probably_person:
          name: "Level bei: Wahrscheinlich Person"
          default: "time-sensitive"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s6_level_definitely_person:
          name: "Level bei: Definitiv Person"
          default: "critical"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s6_gate_enable:
          name: "Gate aktivieren"
          default: false
          selector:
            boolean:

        s6_gate_threshold:
          name: "Gate Schwellwert"
          default: "active"
          selector:
            select:
              options: [passive, active, time-sensitive, critical]

        s6_mobile_push:
          name: "Mobile Push"
          default: true
          selector:
            boolean:

        s6_video_min_detection:
          name: "Video-Analyse ab Detection-Level"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme!"
          default: "no-person"
          selector:
            select:
              options:
                - label: "Immer"
                  value: "always"
                - label: "Ab: Keine Person"
                  value: "no-person"
                - label: "Ab: Wahrscheinlich Person"
                  value: "probably-person"
                - label: "Ab: Definitiv Person"
                  value: "definitely-person"
                - label: "Nie"
                  value: "never"

        s6_tv_notify:
          name: "TV Benachrichtigung"
          default: true
          selector:
            boolean:

        s6_tts_enable:
          name: "Sprachansage (nur bei Critical)"
          default: true
          selector:
            boolean:

        s6_tts_conditions:
          name: "Zusätzliche TTS-Bedingungen"
          default: []
          selector:
            condition:

        s6_alarm_mode:
          name: "Alarm-Wiederholungen"
          default: true
          selector:
            boolean:

        s6_update_push:
          name: "Update-Push nach Video-Analyse"
          description: "⚠️ Benötigt aktivierte Video-Aufnahme und Video-Analyse!"
          default: true
          selector:
            boolean:

    # =======================
    # SONSTIGES
    # =======================
    misc_section:
      name: "Sonstiges"
      description: "Globale Einstellungen"
      icon: mdi:cog
      collapsed: true
      input:
        debug_info_enabled:
          name: "Debug-Infos in Benachrichtigungen"
          description: "Zeigt technische Details in Push-Nachrichten"
          default: true
          selector:
            boolean:

        global_cooldown:
          name: "Globaler Cooldown"
          description: "Pause am Ende der Automation"
          default: { seconds: 20 }
          selector:
            duration: {}

# ================= Variables =================
variables:
  response:
    response_text: ""
  
  camera_entities_list: !input camera_entities
  motion_sensors_list: !input motion_sensors
  notify_devices: !input notify_device
  
  provider: !input provider
  model: !input model
  
  video_duration: !input video_duration
  video_lookback: !input video_lookback
  
  importance_target_width: !input importance_target_width
  importance_max_tokens: !input importance_max_tokens
  importance_max_retries: !input importance_max_retries
  importance_retry_delay: !input importance_retry_delay
  importance_prompt: !input importance_prompt
  
  video_target_width: !input video_target_width
  video_max_frames: !input video_max_frames
  video_max_tokens: !input video_max_tokens
  video_max_retries: !input video_max_retries
  video_retry_delay: !input video_retry_delay
  video_prompt: !input video_prompt
  
  timestamp_filenames: !input timestamp_filenames
  timestamp_format: !input timestamp_format
  snapshot_dir_fs_base: !input snapshot_dir_fs
  snapshot_dir_web_base: !input snapshot_dir_web
  
  tap_navigate: !input tap_navigate
  notification_time: !input notification_time
  notification_sound: !input notification_sound
  notification_volume: !input notification_volume
  notification_sound_critical: !input notification_sound_critical
  notification_volume_critical: !input notification_volume_critical
  delay_notification: !input delay_notification
  alarm_repetition_count: !input alarm_repetition_count
  alarm_repetition_delay: !input alarm_repetition_delay
  
  tts_target_entity: !input tts_target_entity
  tts_media_players: !input tts_media_players
  tts_volume: !input tts_volume
  tts_repeat_count: !input tts_repeat_count
  tts_repeat_delay: !input tts_repeat_delay
  
  lg_tv_enable: !input lg_tv_enable
  lg_tv_conditions: !input lg_tv_conditions
  lg_tv_message_title: !input lg_tv_message_title
  
  other_notify_entities: !input other_notify_entities
  other_notify_conditions: !input other_notify_conditions
  other_notify_title: !input other_notify_title
  
  action1_enabled: !input action1_enabled
  action1_title: !input action1_title
  action1_uri: !input action1_uri
  action1_icon: !input action1_icon
  action1_destructive: !input action1_destructive
  action2_enabled: !input action2_enabled
  action2_title: !input action2_title
  action2_uri: !input action2_uri
  action2_icon: !input action2_icon
  action2_destructive: !input action2_destructive
  action3_enabled: !input action3_enabled
  action3_title: !input action3_title
  action3_uri: !input action3_uri
  action3_icon: !input action3_icon
  action3_destructive: !input action3_destructive
  
  scenario_helper: !input scenario_helper
  scenario_fallback: !input scenario_fallback
  
  s1_conditions: !input s1_conditions
  s1_snapshot: !input s1_snapshot
  s1_video: !input s1_video
  s1_importance_check: !input s1_importance_check
  s1_level_no_person: !input s1_level_no_person
  s1_level_probably_person: !input s1_level_probably_person
  s1_level_definitely_person: !input s1_level_definitely_person
  s1_gate_enable: !input s1_gate_enable
  s1_gate_threshold: !input s1_gate_threshold
  s1_mobile_push: !input s1_mobile_push
  s1_video_min_detection: !input s1_video_min_detection
  s1_tv_notify: !input s1_tv_notify
  s1_tts_enable: !input s1_tts_enable
  s1_tts_conditions: !input s1_tts_conditions
  s1_alarm_mode: !input s1_alarm_mode
  s1_update_push: !input s1_update_push
  
  s2_conditions: !input s2_conditions
  s2_snapshot: !input s2_snapshot
  s2_video: !input s2_video
  s2_importance_check: !input s2_importance_check
  s2_level_no_person: !input s2_level_no_person
  s2_level_probably_person: !input s2_level_probably_person
  s2_level_definitely_person: !input s2_level_definitely_person
  s2_gate_enable: !input s2_gate_enable
  s2_gate_threshold: !input s2_gate_threshold
  s2_mobile_push: !input s2_mobile_push
  s2_video_min_detection: !input s2_video_min_detection
  s2_tv_notify: !input s2_tv_notify
  s2_tts_enable: !input s2_tts_enable
  s2_tts_conditions: !input s2_tts_conditions
  s2_alarm_mode: !input s2_alarm_mode
  s2_update_push: !input s2_update_push
  
  s3_conditions: !input s3_conditions
  s3_snapshot: !input s3_snapshot
  s3_video: !input s3_video
  s3_importance_check: !input s3_importance_check
  s3_level_no_person: !input s3_level_no_person
  s3_level_probably_person: !input s3_level_probably_person
  s3_level_definitely_person: !input s3_level_definitely_person
  s3_gate_enable: !input s3_gate_enable
  s3_gate_threshold: !input s3_gate_threshold
  s3_mobile_push: !input s3_mobile_push
  s3_video_min_detection: !input s3_video_min_detection
  s3_tv_notify: !input s3_tv_notify
  s3_tts_enable: !input s3_tts_enable
  s3_tts_conditions: !input s3_tts_conditions
  s3_alarm_mode: !input s3_alarm_mode
  s3_update_push: !input s3_update_push
  
  s4_conditions: !input s4_conditions
  s4_snapshot: !input s4_snapshot
  s4_video: !input s4_video
  s4_importance_check: !input s4_importance_check
  s4_level_no_person: !input s4_level_no_person
  s4_level_probably_person: !input s4_level_probably_person
  s4_level_definitely_person: !input s4_level_definitely_person
  s4_gate_enable: !input s4_gate_enable
  s4_gate_threshold: !input s4_gate_threshold
  s4_mobile_push: !input s4_mobile_push
  s4_video_min_detection: !input s4_video_min_detection
  s4_tv_notify: !input s4_tv_notify
  s4_tts_enable: !input s4_tts_enable
  s4_tts_conditions: !input s4_tts_conditions
  s4_alarm_mode: !input s4_alarm_mode
  s4_alarm_conditions: !input s4_alarm_conditions
  s4_update_push: !input s4_update_push
  
  s4a_conditions: !input s4a_conditions
  s4a_snapshot: !input s4a_snapshot
  s4a_video: !input s4a_video
  s4a_importance_check: !input s4a_importance_check
  s4a_level_no_person: !input s4a_level_no_person
  s4a_level_probably_person: !input s4a_level_probably_person
  s4a_level_definitely_person: !input s4a_level_definitely_person
  s4a_gate_enable: !input s4a_gate_enable
  s4a_gate_threshold: !input s4a_gate_threshold
  s4a_mobile_push: !input s4a_mobile_push
  s4a_video_min_detection: !input s4a_video_min_detection
  s4a_tv_notify: !input s4a_tv_notify
  s4a_tts_enable: !input s4a_tts_enable
  s4a_tts_conditions: !input s4a_tts_conditions
  s4a_alarm_mode: !input s4a_alarm_mode
  s4a_alarm_conditions: !input s4a_alarm_conditions
  s4a_update_push: !input s4a_update_push
  
  s5_conditions: !input s5_conditions
  s5_snapshot: !input s5_snapshot
  s5_video: !input s5_video
  s5_importance_check: !input s5_importance_check
  s5_level_no_person: !input s5_level_no_person
  s5_level_probably_person: !input s5_level_probably_person
  s5_level_definitely_person: !input s5_level_definitely_person
  s5_gate_enable: !input s5_gate_enable
  s5_gate_threshold: !input s5_gate_threshold
  s5_mobile_push: !input s5_mobile_push
  s5_video_min_detection: !input s5_video_min_detection
  s5_tv_notify: !input s5_tv_notify
  s5_tts_enable: !input s5_tts_enable
  s5_tts_conditions: !input s5_tts_conditions
  s5_alarm_mode: !input s5_alarm_mode
  s5_update_push: !input s5_update_push
  
  s6_conditions: !input s6_conditions
  s6_snapshot: !input s6_snapshot
  s6_video: !input s6_video
  s6_importance_check: !input s6_importance_check
  s6_level_no_person: !input s6_level_no_person
  s6_level_probably_person: !input s6_level_probably_person
  s6_level_definitely_person: !input s6_level_definitely_person
  s6_gate_enable: !input s6_gate_enable
  s6_gate_threshold: !input s6_gate_threshold
  s6_mobile_push: !input s6_mobile_push
  s6_video_min_detection: !input s6_video_min_detection
  s6_tv_notify: !input s6_tv_notify
  s6_tts_enable: !input s6_tts_enable
  s6_tts_conditions: !input s6_tts_conditions
  s6_alarm_mode: !input s6_alarm_mode
  s6_update_push: !input s6_update_push
  
  debug_info_enabled: !input debug_info_enabled
  global_cooldown: !input global_cooldown
  
  camera_entity_snapshot: >
    {% if trigger is defined and trigger.entity_id %}
      {% set tid = trigger.entity_id %}
      {% if tid.startswith('binary_sensor') and (tid in motion_sensors_list) %}
        {% set i = motion_sensors_list.index(tid) %}
        {{ camera_entities_list[i] if camera_entities_list|length > i else (camera_entities_list[0] if camera_entities_list|length>0 else '') }}
      {% elif tid.startswith('camera.') %}
        {{ tid }}
      {% else %}
        {{ camera_entities_list[0] if camera_entities_list|length>0 else '' }}
      {% endif %}
    {% else %}
      {{ camera_entities_list[0] if camera_entities_list|length>0 else '' }}
    {% endif %}
  
  camera_friendly: "{{ state_attr(camera_entity_snapshot, 'friendly_name') or 'Kamera' }}"
  camera_file_path: "{{ camera_friendly | slugify }}"
  snapshot_dir_fs_final: "{{ (snapshot_dir_fs_base.rstrip('/')) ~ '/' ~ camera_file_path }}"
  snapshot_dir_web_final: "{{ (snapshot_dir_web_base.rstrip('/')) ~ '/' ~ camera_file_path }}"
  
  filename_base: "{{ (timestamp_filenames and now().strftime(timestamp_format) or 'last_motion') }}"
  
  snapshot_filename: "{{ filename_base ~ '.jpg' }}"
  file_path: "{{ snapshot_dir_fs_final ~ '/' ~ snapshot_filename }}"
  snapshot_access_file_path: "{{ snapshot_dir_web_final ~ '/' ~ snapshot_filename }}"
  
  video_filename: "{{ filename_base ~ '.mp4' }}"
  video_file_path: "{{ snapshot_dir_fs_final ~ '/' ~ video_filename }}"
  
  label: "Bewegung erkannt"
  camera: "{{ camera_friendly }}"
  notification_tag: "{{ camera_file_path ~ '_' ~ now().timestamp()|int }}"
  
  level_rank: "{{ {'passive':0,'active':1,'time-sensitive':2,'critical':3} }}"
  detection_rank: "{{ {'no-person':0,'probably-person':1,'definitely-person':2} }}"
  
  device_name_map: >
    {% set ns = namespace(device_names=[]) %}
    {% for dev in (notify_devices or []) %}
      {% set name = device_attr(dev, 'name') | default('', true) %}
      {% set slug = (name | slugify) | default('', true) %}
      {% if slug and (slug | length > 0) %}
        {% set ns.device_names = ns.device_names + ['mobile_app_' ~ slug] %}
      {% endif %}
    {% endfor %}
    {{ ns.device_names }}
  
  notify_services_all: "{{ device_name_map }}"

mode: queued
max: 25
max_exceeded: silent

trigger:
  - platform: state
    entity_id: !input camera_entities
    to: !input trigger_state
    id: "camera_trigger"
  - platform: state
    entity_id: !input motion_sensors
    to: "on"
    id: "motion_sensor_trigger"

action:
  # Step 0: Szenario-Bestimmung
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ scenario_helper and is_state(scenario_helper, 'on') }}"
        sequence:
          - variables:
              active_scenario: "6"
      - conditions: !input s1_conditions
        sequence:
          - variables:
              active_scenario: "1"
      - conditions: !input s2_conditions
        sequence:
          - variables:
              active_scenario: "2"
      - conditions: !input s3_conditions
        sequence:
          - variables:
              active_scenario: "3"
      - conditions: !input s4_conditions
        sequence:
          - variables:
              active_scenario: "4"
      - conditions: !input s4a_conditions
        sequence:
          - variables:
              active_scenario: "4a"
      - conditions: !input s5_conditions
        sequence:
          - variables:
              active_scenario: "5"
      - conditions: !input s6_conditions
        sequence:
          - variables:
              active_scenario: "6"
    default:
      - variables:
          active_scenario: !input scenario_fallback
  
  # Load scenario settings
  - variables:
      current_snapshot: >
        {% if active_scenario == '1' %}{{ s1_snapshot }}
        {% elif active_scenario == '2' %}{{ s2_snapshot }}
        {% elif active_scenario == '3' %}{{ s3_snapshot }}
        {% elif active_scenario == '4' %}{{ s4_snapshot }}
        {% elif active_scenario == '4a' %}{{ s4a_snapshot }}
        {% elif active_scenario == '5' %}{{ s5_snapshot }}
        {% elif active_scenario == '6' %}{{ s6_snapshot }}
        {% else %}true{% endif %}
      current_video: >
        {% if active_scenario == '1' %}{{ s1_video }}
        {% elif active_scenario == '2' %}{{ s2_video }}
        {% elif active_scenario == '3' %}{{ s3_video }}
        {% elif active_scenario == '4' %}{{ s4_video }}
        {% elif active_scenario == '4a' %}{{ s4a_video }}
        {% elif active_scenario == '5' %}{{ s5_video }}
        {% elif active_scenario == '6' %}{{ s6_video }}
        {% else %}true{% endif %}
      current_importance: >
        {% if active_scenario == '1' %}{{ s1_importance_check }}
        {% elif active_scenario == '2' %}{{ s2_importance_check }}
        {% elif active_scenario == '3' %}{{ s3_importance_check }}
        {% elif active_scenario == '4' %}{{ s4_importance_check }}
        {% elif active_scenario == '4a' %}{{ s4a_importance_check }}
        {% elif active_scenario == '5' %}{{ s5_importance_check }}
        {% elif active_scenario == '6' %}{{ s6_importance_check }}
        {% else %}false{% endif %}
      current_level_no_person: >
        {% if active_scenario == '1' %}{{ s1_level_no_person }}
        {% elif active_scenario == '2' %}{{ s2_level_no_person }}
        {% elif active_scenario == '3' %}{{ s3_level_no_person }}
        {% elif active_scenario == '4' %}{{ s4_level_no_person }}
        {% elif active_scenario == '4a' %}{{ s4a_level_no_person }}
        {% elif active_scenario == '5' %}{{ s5_level_no_person }}
        {% elif active_scenario == '6' %}{{ s6_level_no_person }}
        {% else %}passive{% endif %}
      current_level_probably_person: >
        {% if active_scenario == '1' %}{{ s1_level_probably_person }}
        {% elif active_scenario == '2' %}{{ s2_level_probably_person }}
        {% elif active_scenario == '3' %}{{ s3_level_probably_person }}
        {% elif active_scenario == '4' %}{{ s4_level_probably_person }}
        {% elif active_scenario == '4a' %}{{ s4a_level_probably_person }}
        {% elif active_scenario == '5' %}{{ s5_level_probably_person }}
        {% elif active_scenario == '6' %}{{ s6_level_probably_person }}
        {% else %}active{% endif %}
      current_level_definitely_person: >
        {% if active_scenario == '1' %}{{ s1_level_definitely_person }}
        {% elif active_scenario == '2' %}{{ s2_level_definitely_person }}
        {% elif active_scenario == '3' %}{{ s3_level_definitely_person }}
        {% elif active_scenario == '4' %}{{ s4_level_definitely_person }}
        {% elif active_scenario == '4a' %}{{ s4a_level_definitely_person }}
        {% elif active_scenario == '5' %}{{ s5_level_definitely_person }}
        {% elif active_scenario == '6' %}{{ s6_level_definitely_person }}
        {% else %}critical{% endif %}
      current_gate_enable: >
        {% if active_scenario == '1' %}{{ s1_gate_enable }}
        {% elif active_scenario == '2' %}{{ s2_gate_enable }}
        {% elif active_scenario == '3' %}{{ s3_gate_enable }}
        {% elif active_scenario == '4' %}{{ s4_gate_enable }}
        {% elif active_scenario == '4a' %}{{ s4a_gate_enable }}
        {% elif active_scenario == '5' %}{{ s5_gate_enable }}
        {% elif active_scenario == '6' %}{{ s6_gate_enable }}
        {% else %}false{% endif %}
      current_gate_threshold: >
        {% if active_scenario == '1' %}{{ s1_gate_threshold }}
        {% elif active_scenario == '2' %}{{ s2_gate_threshold }}
        {% elif active_scenario == '3' %}{{ s3_gate_threshold }}
        {% elif active_scenario == '4' %}{{ s4_gate_threshold }}
        {% elif active_scenario == '4a' %}{{ s4a_gate_threshold }}
        {% elif active_scenario == '5' %}{{ s5_gate_threshold }}
        {% elif active_scenario == '6' %}{{ s6_gate_threshold }}
        {% else %}active{% endif %}
      current_mobile_push: >
        {% if active_scenario == '1' %}{{ s1_mobile_push }}
        {% elif active_scenario == '2' %}{{ s2_mobile_push }}
        {% elif active_scenario == '3' %}{{ s3_mobile_push }}
        {% elif active_scenario == '4' %}{{ s4_mobile_push }}
        {% elif active_scenario == '4a' %}{{ s4a_mobile_push }}
        {% elif active_scenario == '5' %}{{ s5_mobile_push }}
        {% elif active_scenario == '6' %}{{ s6_mobile_push }}
        {% else %}true{% endif %}
      current_video_min_detection: >
        {% if active_scenario == '1' %}{{ s1_video_min_detection }}
        {% elif active_scenario == '2' %}{{ s2_video_min_detection }}
        {% elif active_scenario == '3' %}{{ s3_video_min_detection }}
        {% elif active_scenario == '4' %}{{ s4_video_min_detection }}
        {% elif active_scenario == '4a' %}{{ s4a_video_min_detection }}
        {% elif active_scenario == '5' %}{{ s5_video_min_detection }}
        {% elif active_scenario == '6' %}{{ s6_video_min_detection }}
        {% else %}never{% endif %}
      current_tv_notify: >
        {% if active_scenario == '1' %}{{ s1_tv_notify }}
        {% elif active_scenario == '2' %}{{ s2_tv_notify }}
        {% elif active_scenario == '3' %}{{ s3_tv_notify }}
        {% elif active_scenario == '4' %}{{ s4_tv_notify }}
        {% elif active_scenario == '4a' %}{{ s4a_tv_notify }}
        {% elif active_scenario == '5' %}{{ s5_tv_notify }}
        {% elif active_scenario == '6' %}{{ s6_tv_notify }}
        {% else %}false{% endif %}
      current_tts_enable: >
        {% if active_scenario == '1' %}{{ s1_tts_enable }}
        {% elif active_scenario == '2' %}{{ s2_tts_enable }}
        {% elif active_scenario == '3' %}{{ s3_tts_enable }}
        {% elif active_scenario == '4' %}{{ s4_tts_enable }}
        {% elif active_scenario == '4a' %}{{ s4a_tts_enable }}
        {% elif active_scenario == '5' %}{{ s5_tts_enable }}
        {% elif active_scenario == '6' %}{{ s6_tts_enable }}
        {% else %}false{% endif %}
      current_alarm_mode: >
        {% if active_scenario == '1' %}{{ s1_alarm_mode }}
        {% elif active_scenario == '2' %}{{ s2_alarm_mode }}
        {% elif active_scenario == '3' %}{{ s3_alarm_mode }}
        {% elif active_scenario == '4' %}{{ s4_alarm_mode }}
        {% elif active_scenario == '4a' %}{{ s4a_alarm_mode }}
        {% elif active_scenario == '5' %}{{ s5_alarm_mode }}
        {% elif active_scenario == '6' %}{{ s6_alarm_mode }}
        {% else %}false{% endif %}
      current_alarm_conditions: >
        {% if active_scenario == '4' %}{{ s4_alarm_conditions | default([]) }}
        {% elif active_scenario == '4a' %}{{ s4a_alarm_conditions | default([]) }}
        {% else %}[]{% endif %}
      current_update_push: >
        {% if active_scenario == '1' %}{{ s1_update_push }}
        {% elif active_scenario == '2' %}{{ s2_update_push }}
        {% elif active_scenario == '3' %}{{ s3_update_push }}
        {% elif active_scenario == '4' %}{{ s4_update_push }}
        {% elif active_scenario == '4a' %}{{ s4a_update_push }}
        {% elif active_scenario == '5' %}{{ s5_update_push }}
        {% elif active_scenario == '6' %}{{ s6_update_push }}
        {% else %}false{% endif %}
  
  # Check notification cooldown
  - if:
      - condition: template
        value_template: >
          {{ not this.attributes.last_triggered
             or (now() - this.attributes.last_triggered).seconds > delay_notification }}
    then:
      # 1) Create snapshot and/or video
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ current_snapshot and current_video and camera_entity_snapshot != '' }}"
            sequence:
              - parallel:
                  - service: camera.snapshot
                    target:
                      entity_id: "{{ camera_entity_snapshot }}"
                    data:
                      filename: "{{ file_path }}"
                  - service: camera.record
                    target:
                      entity_id: "{{ camera_entity_snapshot }}"
                    data:
                      filename: "{{ video_file_path }}"
                      duration: "{{ video_duration }}"
                      lookback: "{{ video_lookback }}"
          - conditions:
              - condition: template
                value_template: "{{ current_snapshot and not current_video and camera_entity_snapshot != '' }}"
            sequence:
              - service: camera.snapshot
                target:
                  entity_id: "{{ camera_entity_snapshot }}"
                data:
                  filename: "{{ file_path }}"
          - conditions:
              - condition: template
                value_template: "{{ not current_snapshot and current_video and camera_entity_snapshot != '' }}"
            sequence:
              - service: camera.record
                target:
                  entity_id: "{{ camera_entity_snapshot }}"
                data:
                  filename: "{{ video_file_path }}"
                  duration: "{{ video_duration }}"
                  lookback: "{{ video_lookback }}"
      
      # 2) Importance analysis
      - variables:
          importance_status: "{% if current_importance %}pending{% else %}disabled{% endif %}"
          importance_attempts_used: 0
          _importance_result_temp: ""
      
      - if:
          - condition: template
            value_template: "{{ current_importance }}"
        then:
          - repeat:
              while:
                - condition: template
                  value_template: >
                    {% set valid = ['no-person', 'probably-person', 'definitely-person'] %}
                    {% set r = _importance_result_temp | lower %}
                    {% set ok = valid | select('in', r) | list | length > 0 %}
                    {{ not ok and repeat.index <= importance_max_retries }}
              sequence:
                - if:
                    - condition: template
                      value_template: "{{ repeat.index > 1 }}"
                  then:
                    - delay: !input importance_retry_delay
                - action: llmvision.image_analyzer
                  data:
                    image_file: "{{ file_path }}"
                    provider: !input provider
                    model: !input model
                    message: >
                      {% if repeat.index > 1 %}IMPORTANT: Respond with EXACTLY one label: no-person, probably-person, or definitely-person. Nothing else.
                      
                      {% endif %}{{ importance_prompt }}
                    include_filename: true
                    target_width: "{{ importance_target_width }}"
                    max_tokens: "{{ importance_max_tokens }}"
                    remember: true
                  response_variable: _importance_response
                - variables:
                    _importance_result_temp: "{{ _importance_response.response_text | default('') }}"
                    importance_attempts_used: "{{ repeat.index }}"
          - variables:
              importance_status: >
                {% if _importance_result_temp == '' %}no_response
                {% elif 'definitely-person' in (_importance_result_temp | lower) %}success
                {% elif 'probably-person' in (_importance_result_temp | lower) %}success
                {% elif 'no-person' in (_importance_result_temp | lower) %}success
                {% else %}invalid_response{% endif %}
      
      # 2b) Detection level
      - variables:
          detection_level: >
            {% if importance_status == 'disabled' %}none
            {% elif importance_status in ['no_response', 'invalid_response'] %}probably-person
            {% else %}
              {% set t = _importance_result_temp | lower %}
              {% if 'definitely-person' in t %}definitely-person
              {% elif 'probably-person' in t %}probably-person
              {% elif 'no-person' in t %}no-person
              {% else %}probably-person{% endif %}
            {% endif %}
          initial_interruption_level: >
            {% if detection_level == 'definitely-person' %}{{ current_level_definitely_person }}
            {% elif detection_level == 'probably-person' %}{{ current_level_probably_person }}
            {% else %}{{ current_level_no_person }}{% endif %}
      
      # 3) Gate check
      - if:
          - condition: template
            value_template: "{{ current_gate_enable }}"
          - condition: template
            value_template: "{{ (level_rank[initial_interruption_level]|default(0)) < (level_rank[current_gate_threshold]|default(0)) }}"
        then:
          - stop: "Gate: Level {{ initial_interruption_level }} < Threshold {{ current_gate_threshold }}"
      
      # 4) Mobile push notification
      - if:
          - condition: template
            value_template: "{{ current_mobile_push }}"
        then:
          - repeat:
              for_each: "{{ notify_services_all }}"
              sequence:
                - service: "notify.{{ repeat.item }}"
                  data:
                    title: "{{ camera }} - {{ label }} {{ notification_time }}"
                    message: >
                      {% if importance_status == 'disabled' %}Bewegung erkannt
                      {% elif importance_status == 'no_response' %}Bewegung erkannt - Analyse nicht möglich
                      {% elif importance_status == 'invalid_response' %}Bewegung erkannt - Analyse fehlerhaft
                      {% elif detection_level == 'definitely-person' %}Person erkannt
                      {% elif detection_level == 'probably-person' %}Möglicherweise Person erkannt
                      {% else %}Bewegung erkannt - keine Person{% endif %}
                      {% if debug_info_enabled %}
                      
                      (S{{ active_scenario }} | {{ detection_level }} | {{ initial_interruption_level }}{% if importance_attempts_used > 1 %} | {{ importance_attempts_used }}x{% endif %})
                      {% endif %}
                    data:
                      url: "{{ tap_navigate }}"
                      clickAction: "{{ tap_navigate }}"
                      tag: "{{ notification_tag }}"
                      group: "cams"
                      attachment:
                        url: "{{ snapshot_access_file_path }}"
                        content_type: JPEG
                      actions: >
                        {% set actions = [] %}
                        {% if action1_enabled %}
                          {% set a = {'action': 'ACTION_1', 'title': action1_title, 'destructive': action1_destructive} %}
                          {% if action1_uri %}{% set a = a | combine({'uri': action1_uri}) %}{% endif %}
                          {% if action1_icon %}{% set a = a | combine({'icon': action1_icon}) %}{% endif %}
                          {% set actions = actions + [a] %}
                        {% endif %}
                        {% if action2_enabled %}
                          {% set a = {'action': 'ACTION_2', 'title': action2_title, 'destructive': action2_destructive} %}
                          {% if action2_uri %}{% set a = a | combine({'uri': action2_uri}) %}{% endif %}
                          {% if action2_icon %}{% set a = a | combine({'icon': action2_icon}) %}{% endif %}
                          {% set actions = actions + [a] %}
                        {% endif %}
                        {% if action3_enabled %}
                          {% set a = {'action': 'ACTION_3', 'title': action3_title, 'destructive': action3_destructive} %}
                          {% if action3_uri %}{% set a = a | combine({'uri': action3_uri}) %}{% endif %}
                          {% if action3_icon %}{% set a = a | combine({'icon': action3_icon}) %}{% endif %}
                          {% set actions = actions + [a] %}
                        {% endif %}
                        {{ actions }}
                      push:
                        interruption-level: "{{ initial_interruption_level }}"
                        sound:
                          name: "{{ notification_sound_critical if initial_interruption_level == 'critical' else notification_sound }}"
                          volume: "{{ notification_volume_critical if initial_interruption_level == 'critical' else notification_volume }}"
                          critical: "{{ initial_interruption_level == 'critical' }}"
      
      # 5) Video analysis (only if video was recorded)
      - variables:
          video_should_run: >
            {% if not current_video %}false
            {% elif current_video_min_detection == 'always' %}true
            {% elif current_video_min_detection == 'never' %}false
            {% elif current_video_min_detection == 'no-person' %}true
            {% elif current_video_min_detection == 'probably-person' and detection_rank[detection_level] >= 1 %}true
            {% elif current_video_min_detection == 'definitely-person' and detection_rank[detection_level] >= 2 %}true
            {% else %}false{% endif %}
          video_status: "{% if video_should_run %}pending{% else %}disabled{% endif %}"
          video_result: ""
          video_attempts_used: 0
          verified_detection: "{{ detection_level }}"
          final_interruption_level: "{{ initial_interruption_level }}"
      
      - if:
          - condition: template
            value_template: "{{ video_should_run and camera_entity_snapshot != '' }}"
        then:
          - variables:
              _video_result_temp: "Unklar"
          - repeat:
              while:
                - condition: template
                  value_template: "{{ _video_result_temp == 'Unklar' and repeat.index <= video_max_retries }}"
              sequence:
                - if:
                    - condition: template
                      value_template: "{{ repeat.index > 1 }}"
                  then:
                    - delay: !input video_retry_delay
                - action: llmvision.video_analyzer
                  data:
                    video_file: "{{ video_file_path }}"
                    provider: !input provider
                    model: !input model
                    message: >
                      {% if repeat.index > 1 %}IMPORTANT: Avoid "Unklar". Make your best assessment.
                      
                      {% endif %}{{ video_prompt }}
                    include_filename: true
                    max_frames: "{{ video_max_frames }}"
                    target_width: "{{ video_target_width }}"
                    max_tokens: "{{ video_max_tokens }}"
                    remember: true
                  response_variable: _response
                - variables:
                    _video_result_temp: "{{ _response.response_text | default('') }}"
                    video_attempts_used: "{{ repeat.index }}"
          - variables:
              video_status: >
                {% if _video_result_temp == '' %}no_response
                {% elif _video_result_temp == 'Unklar' %}still_unclear
                {% else %}success{% endif %}
              video_result: "{{ _video_result_temp }}"
              verified_detection: >
                {% if _video_result_temp in ['Person erkannt', 'Mehrere Personen', 'Person und Fahrzeug'] %}definitely-person
                {% else %}{{ detection_level }}{% endif %}
              final_interruption_level: >
                {% set _v = 'definitely-person' if _video_result_temp in ['Person erkannt', 'Mehrere Personen', 'Person und Fahrzeug'] else detection_level %}
                {% if _v == 'definitely-person' %}{{ current_level_definitely_person }}
                {% elif _v == 'probably-person' %}{{ current_level_probably_person }}
                {% else %}{{ current_level_no_person }}{% endif %}
      
      # 6) TV notifications
      - if:
          - condition: template
            value_template: "{{ current_tv_notify and lg_tv_enable }}"
          - condition: and
            conditions: !input lg_tv_conditions
        then:
          - service: notify.lg_webos_smart_tv
            data:
              title: "{{ lg_tv_message_title }}"
              message: >
                {% if video_status == 'success' and video_result %}{{ camera_friendly }}: {{ video_result }}
                {% elif detection_level == 'definitely-person' %}{{ camera_friendly }}: Person erkannt
                {% elif detection_level == 'probably-person' %}{{ camera_friendly }}: Möglicherweise Person
                {% else %}{{ camera_friendly }}: Bewegung erkannt{% endif %}
      
      - if:
          - condition: template
            value_template: "{{ current_tv_notify and other_notify_entities|length > 0 }}"
          - condition: and
            conditions: !input other_notify_conditions
        then:
          - repeat:
              for_each: "{{ other_notify_entities }}"
              sequence:
                - service: "{{ repeat.item }}"
                  data:
                    title: "{{ other_notify_title }}"
                    message: >
                      {% if video_status == 'success' and video_result %}{{ camera_friendly }}: {{ video_result }}
                      {% elif detection_level == 'definitely-person' %}{{ camera_friendly }}: Person erkannt
                      {% elif detection_level == 'probably-person' %}{{ camera_friendly }}: Möglicherweise Person
                      {% else %}{{ camera_friendly }}: Bewegung erkannt{% endif %}
      
      # 7) TTS announcement
      - if:
          - condition: template
            value_template: "{{ current_tts_enable }}"
          - condition: template
            value_template: "{{ final_interruption_level == 'critical' }}"
          - condition: template
            value_template: "{{ tts_media_players|length > 0 }}"
          - condition: template
            value_template: "{{ tts_target_entity != none and tts_target_entity|length > 0 }}"
        then:
          - repeat:
              count: "{{ tts_repeat_count }}"
              sequence:
                - if:
                    - condition: template
                      value_template: "{{ repeat.index > 1 }}"
                  then:
                    - delay: !input tts_repeat_delay
                - repeat:
                    for_each: "{{ tts_media_players }}"
                    sequence:
                      - service: media_player.volume_set
                        target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          volume_level: "{{ tts_volume }}"
                      - service: tts.speak
                        target:
                          entity_id: "{{ tts_target_entity }}"
                        data:
                          cache: false
                          media_player_entity_id: "{{ repeat.item }}"
                          message: >
                            {% if video_status == 'success' and video_result %}Achtung! {{ camera_friendly }}: {{ video_result }}
                            {% elif detection_level == 'definitely-person' %}Achtung! {{ camera_friendly }}: Person erkannt
                            {% elif detection_level == 'probably-person' %}Achtung! {{ camera_friendly }}: Möglicherweise Person
                            {% else %}Achtung! {{ camera_friendly }} meldet kritisches Ereignis{% endif %}
      
      # 8) Update push
      - if:
          - condition: template
            value_template: "{{ current_update_push and video_status != 'disabled' }}"
        then:
          - repeat:
              count: "{{ alarm_repetition_count if current_alarm_mode else 1 }}"
              sequence:
                - if:
                    - condition: template
                      value_template: "{{ repeat.index > 1 }}"
                  then:
                    - delay: !input alarm_repetition_delay
                - repeat:
                    for_each: "{{ notify_services_all }}"
                    sequence:
                      - service: "notify.{{ repeat.item }}"
                        data:
                          title: "{{ camera }} - Update {{ notification_time }}"
                          message: >
                            {% if video_status == 'no_response' %}Video-Analyse nicht möglich
                            {% elif video_status == 'still_unclear' %}Video-Analyse blieb unklar
                            {% elif verified_detection != detection_level %}VERIFIZIERT: {{ video_result }}
                            {% else %}{{ video_result }}{% endif %}
                            {% if debug_info_enabled %}
                            
                            (S{{ active_scenario }} | {{ detection_level }}→{{ verified_detection }} | {{ final_interruption_level }} | {{ video_attempts_used }}x)
                            {% endif %}
                          data:
                            url: "{{ tap_navigate }}"
                            clickAction: "{{ tap_navigate }}"
                            tag: "{{ notification_tag }}"
                            group: "cams"
                            attachment:
                              url: "{{ snapshot_access_file_path }}"
                              content_type: JPEG
                            actions: >
                              {% set actions = [] %}
                              {% if action1_enabled %}
                                {% set a = {'action': 'ACTION_1', 'title': action1_title, 'destructive': action1_destructive} %}
                                {% if action1_uri %}{% set a = a | combine({'uri': action1_uri}) %}{% endif %}
                                {% if action1_icon %}{% set a = a | combine({'icon': action1_icon}) %}{% endif %}
                                {% set actions = actions + [a] %}
                              {% endif %}
                              {% if action2_enabled %}
                                {% set a = {'action': 'ACTION_2', 'title': action2_title, 'destructive': action2_destructive} %}
                                {% if action2_uri %}{% set a = a | combine({'uri': action2_uri}) %}{% endif %}
                                {% if action2_icon %}{% set a = a | combine({'icon': action2_icon}) %}{% endif %}
                                {% set actions = actions + [a] %}
                              {% endif %}
                              {% if action3_enabled %}
                                {% set a = {'action': 'ACTION_3', 'title': action3_title, 'destructive': action3_destructive} %}
                                {% if action3_uri %}{% set a = a | combine({'uri': action3_uri}) %}{% endif %}
                                {% if action3_icon %}{% set a = a | combine({'icon': action3_icon}) %}{% endif %}
                                {% set actions = actions + [a] %}
                              {% endif %}
                              {{ actions }}
                            push:
                              interruption-level: "{{ final_interruption_level }}"
                              sound:
                                name: "{{ notification_sound_critical if final_interruption_level == 'critical' else notification_sound }}"
                                volume: "{{ notification_volume_critical if final_interruption_level == 'critical' else notification_volume }}"
                                critical: "{{ final_interruption_level == 'critical' }}"
  
  # Global cooldown
  - delay: !input global_cooldown

blueprint:
  name: "Camera Event Notification 1.9.1"
  author: "MF"
  homeassistant:
    min_version: 2024.10.0
  description: >
    iOS-Kamera-Benachrichtigung mit Snapshot, Wichtigkeitsanalyse (llmvision.image_analyzer),
    optionaler Live-Analyse (llmvision.stream_analyzer) und Update der Push via Tag.
    Gate mit konfigurierbarem Threshold, dynamisches Interruption-Level aus der Wichtigkeitsanalyse,
    Alarm-Modus (mehrere Pushs bei wichtigen Ereignissen), Text-to-Speech bei critical
    sowie Action-Buttons ohne internes Warten (Events separat abfangbar).
    Eingaben sind in logische, einklappbare Sektionen gegliedert.

  domain: automation
  source_url: https://github.com/michaelf988/ha-cam-snapshot/blob/main/ha-cam-snapshot.yaml

  input:

    # =======================
    # 1) KAMERAS & SENSOREN
    # =======================
    cameras_section:
      name: "Kameras & Sensoren"
      description: "Kamera- und Bewegungsmelder-Einstellungen."
      icon: mdi:camera
      collapsed: true
      input:
        camera_entities:
          name: "Camera Entities"
          description: "Eine oder mehrere Kameras (Snapshot standardmäßig von der ersten)."
          selector:
            entity:
              multiple: true
              filter:
                domain: camera

        trigger_state:
          name: "Trigger State"
          description: "Automation startet, wenn eine Kamera in diesen Zustand wechselt."
          default: "recording"
          selector:
            text:

        motion_sensors:
          name: "Motion Sensors (optional)"
          description: "Nutzen, wenn Kameras den Zustand nicht ändern. Reihenfolge = Reihenfolge der Kameras."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain: binary_sensor

    # =======================
    # 2) SPEICHERUNG & DATEIPFADE
    # =======================
    storage_section:
      name: "Speicherung & Dateipfade"
      description: "Dateinamen & Basis-Pfade für Snapshots."
      icon: mdi:folder
      collapsed: true
      input:
        timestamp_filenames:
          name: "Zeitstempel-Dateinamen verwenden"
          description: "Wenn aktiv, speichert jeden Snapshot als YYYY-MM-DD_HH-MM-SS.jpg."
          default: true
          selector:
            boolean:
        timestamp_format:
          name: "Zeitstempel-Format"
          description: "strftime-Format; Standard: %Y-%m-%d_%H-%M-%S"
          default: "%Y-%m-%d_%H-%M-%S"
          selector:
            text:

        snapshot_dir_fs:
          name: "Basis-Pfad (Dateisystem)"
          description: "Ohne Kamera-Slug; z. B. /config/www/llmvision"
          default: "/config/www/llmvision"
          selector:
            text:
        snapshot_dir_web:
          name: "Basis-Pfad (Web)"
          description: "Ohne Kamera-Slug; z. B. /local/llmvision"
          default: "/local/llmvision"
          selector:
            text:

    # =======================
    # 3) WICHTIGKEITSANALYSE (IMAGE ANALYZER)
    # =======================
    importance_section:
      name: "Wichtigkeitsanalyse (Image Analyzer)"
      description: "Einstufung in passive / active / time-sensitive / critical anhand des Snapshots."
      icon: mdi:shield-search
      collapsed: true
      input:
        importance_enable:
          name: "Wichtigkeits-Check aktivieren (llmvision.image_analyzer)"
          default: false
          selector:
            boolean:

        importance_run_conditions:
          name: "Bedingungen für Wichtigkeits-Check"
          description: "Alle Bedingungen müssen erfüllt sein, damit image_analyzer läuft."
          default: []
          selector:
            condition:

        importance_prompt:
          name: "Prompt für Wichtigkeits-Check"
          description: >
            Liefert genau eines der Wörter: passive, active, time-sensitive, critical.
            Mapping: passive=keine Person; active=wahrscheinlich Person; time-sensitive=definitiv Person;
            critical=Person ODER gefährliche Situation (oder Nacht).
          default: >
            The current time is {{ now().strftime('%H:%M') }}.
            Classify the security relevance of this camera image using ONLY one of the following four labels:

            "passive" – no person, no threat, likely irrelevant event.
            "active" – possible person or unclear object, not immediately dangerous.
            "time-sensitive" – definitely a person, or a clearly relevant moving object.
            "critical" – a person in a potentially dangerous context (e.g. burglary, forced entry, suspicious behavior, fire),
                          OR any person detected during night hours (00:00–05:00).

            Return ONE of these labels ONLY, without any additional text.
          selector:
            text:
              multiline: true

        importance_gate_enable:
          name: "Nur wichtige Ereignisse weiterverarbeiten (Gate)"
          description: >
            Wenn aktiv, wird die Automation nur fortgesetzt, wenn das Ereignis mindestens dem gewählten Threshold entspricht.
          default: false
          selector:
            boolean:

        importance_gate_min_level:
          name: "Gate-Threshold (ab diesem Level weiterverarbeiten)"
          default: "time-sensitive"
          selector:
            select:
              mode: dropdown
              options:
                - passive
                - active
                - time-sensitive
                - critical

        importance_gate_conditions:
          name: "Gate: Zusätzliche Bedingungen"
          description: "Diese Bedingungen müssen zusätzlich erfüllt sein, damit das Gate greift."
          default: []
          selector:
            condition:

        ai_force_on_critical:
          name: "Stream-Analyse erzwingen bei 'critical'"
          description: "Ignoriere ai_enable & Zusatzbedingungen, wenn die Wichtigkeitsanalyse 'critical' ergibt."
          default: true
          selector:
            boolean:

    # =======================
    # 4) LIVE-ANALYSE (STREAM ANALYZER)
    # =======================
    stream_ai_section:
      name: "Live-Analyse (Stream Analyzer)"
      description: "Optionale Analyse des Live-Streams über llmvision.stream_analyzer."
      icon: mdi:cctv
      collapsed: true
      input:
        ai_enable:
          name: "AI Stream Analyzer aktivieren"
          default: false
          selector:
            boolean:

        ai_run_conditions:
          name: "AI: Bedingungen (Stream)"
          description: "Alle müssen erfüllt sein, damit die Live-Analyse läuft."
          default: []
          selector:
            condition:

        provider:
          name: "Provider"
          description: "Provider für Analyse (aus llmvision-Integration)."
          selector:
            config_entry:
              integration: llmvision

        model:
          name: "Model"
          description: "Modell (abhängig vom gewählten Provider)."
          default: "gpt-4o-mini"
          selector:
            text:

        ai_message:
          name: "AI: Prompt (Stream Analyzer, sehr kurz)"
          description: "Sehr kurze, knappe Erkennungsausgabe."
          default: >
            Antworte NUR mit einem der folgenden kurzen Stichwörtern (Deutsch), ohne Zusatz:
            "Person erkannt", "Fahrzeug erkannt", "Person & Fahrzeug", "Mehrere Personen",
            "Tier erkannt", "Unklar", "Keine relevante Bewegung".
          selector:
            text:
              multiline: true

        duration:
          name: "AI: duration (s)"
          default: 3
          selector:
            number:
              min: 1
              max: 60

        max_frames:
          name: "AI: max_frames"
          default: 3
          selector:
            number:
              min: 1
              max: 60

        target_width:
          name: "AI: target_width"
          default: 1280
          selector:
            number:
              min: 512
              max: 3840

        max_tokens:
          name: "AI: max_tokens"
          default: 100
          selector:
            number:
              min: 1
              max: 300

    # =======================
    # 5) BENACHRICHTIGUNGEN (iOS PUSH)
    # =======================
    notifications_section:
      name: "Benachrichtigungen (iOS Push)"
      description: "Zustellung, Inhalte und iOS-Optionen."
      icon: mdi:bell
      collapsed: true
      input:
        notify:
          name: "Enable Notifications"
          default: true
          selector:
            boolean:

        notify_device:
          name: "Notify Device(s)"
          description: "Zielgeräte (Home Assistant Companion)."
          selector:
            device:
              multiple: true
              filter:
                integration: mobile_app

        notify_groups:
          name: "Notify-Gruppen (optional)"
          description: "Kommagetrennte Service-Namen ohne Leerzeichen, z. B.: notify.family,notify.ios_all"
          default: ""
          selector:
            text:

        notification_time:
          name: "Zeit im Titel (optional)"
          default: ""
          selector:
            select:
              options:
                - label: "No Time Added"
                  value: ""
                - label: "12/24 Hour (de)"
                  value: "um {{ now().strftime('%H:%M') }}"

        tap_navigate:
          name: "Tap / Click Action Path"
          default: "/lovelace/test"
          selector:
            text:

        notification_sound:
          name: "iOS Sound"
          default: "LiquidDetected.caf"
          selector:
            text:

        notification_volume:
          name: "iOS Sound Volume (0..1)"
          default: 1
          selector:
            number:
              min: 0
              max: 1
              step: 0.1

        delay_notification:
          name: "Notification Cooldown (seconds)"
          description: "Lokaler Throttle: Verhindert unmittelbare Doppel-Trigger (prüft last_triggered)."
          default: 15
          selector:
            number:
              min: 0
              max: 600
              unit_of_measurement: seconds

    # =======================
    # 6) ALARMFUNKTIONEN
    # =======================
    alarm_section:
      name: "Alarmfunktionen"
      description: "Mehrfach-Benachrichtigungen bei wichtigen Ereignissen."
      icon: mdi:alarm-light
      collapsed: true
      input:
        alarm_repetition_enable:
          name: "Alarm-Wiederholung aktivieren"
          description: "Mehrfach hintereinander benachrichtigen (mit Ton) bei wichtigen Ereignissen."
          default: false
          selector:
            boolean:
        alarm_repetition_count:
          name: "Anzahl Alarm-Wiederholungen"
          default: 5
          selector:
            number:
              min: 1
              max: 20
        alarm_repetition_delay:
          name: "Pause zwischen Alarm-Wiederholungen"
          default: { seconds: 3 }
          selector:
            duration: {}
        alarm_repetition_conditions:
          name: "Bedingungen für Alarm-Wiederholungen"
          description: "Nur wenn alle Bedingungen erfüllt sind, wird die Alarm-Wiederholung ausgeführt."
          default: []
          selector:
            condition:

    # =======================
    # 7) TEXT-TO-SPEECH (CRITICAL-ANSAGEN)
    # =======================
    tts_section:
      name: "Text-to-Speech (Critical-Ansagen)"
      description: "Kritische Ereignisse zusätzlich über Lautsprecher ansagen."
      icon: mdi:volume-high
      collapsed: true
      input:
        tts_enable:
          name: "TTS bei critical aktivieren"
          description: "Sprachansage nur bei kritischen Ereignissen."
          default: false
          selector:
            boolean:

        tts_target_entity:
          name: "TTS-Entity (tts.speak)"
          description: "z. B. tts.home_assistant_cloud"
          selector:
            entity:
              filter:
                domain: tts

        tts_media_players:
          name: "Media-Player für TTS"
          description: "Ein oder mehrere Lautsprecher/Media-Player."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                domain: media_player

        tts_volume:
          name: "TTS-Lautstärke"
          default: 0.5
          selector:
            number:
              min: 0
              max: 1
              step: 0.05

        tts_message:
          name: "TTS-Text"
          description: "Variablen wie {{ camera }} erlaubt. Keine Mehrzeiler."
          default: "Achtung. Kritisches Ereignis durch Kamera {{ camera }} erkannt."
          selector:
            text:
              multiline: false

        tts_repeat_count:
          name: "TTS Wiederholungen"
          description: "Wie oft der TTS-Text wiederholt werden soll."
          default: 3
          selector:
            number:
              min: 1
              max: 10

        tts_repeat_delay:
          name: "Pause zwischen TTS-Wiederholungen"
          default: { seconds: 1 }
          selector:
            duration: {}

        tts_conditions:
          name: "Bedingungen für TTS"
          description: "Alle Bedingungen müssen erfüllt sein, damit TTS ausgeführt wird."
          default: []
          selector:
            condition:

    # =======================
    # 8) ACTION BUTTONS
    # =======================
    action_buttons_section:
      name: "Action Buttons"
      description: "Konfiguration der drei Actionable Notification Buttons (ACTION_1–3)."
      icon: mdi:gesture-tap-button
      collapsed: true
      input:
        action1_enabled:
          name: "Option 1 aktiv"
          default: false
          selector:
            boolean:
        action1_title:
          name: "Option 1 – Titel"
          default: "Öffnen"
          selector:
            text:
        action1_icon:
          name: "Option 1 – Icon (iOS)"
          description: "z. B. sfsymbols:bell"
          default: ""
          selector:
            text:
        action1_destructive:
          name: "Option 1 – Destructive (rot, iOS)"
          default: false
          selector:
            boolean:

        action2_enabled:
          name: "Option 2 aktiv"
          default: false
          selector:
            boolean:
        action2_title:
          name: "Option 2 – Titel"
          default: "Snooze 15 min"
          selector:
            text:
        action2_icon:
          name: "Option 2 – Icon (iOS)"
          default: ""
          selector:
            text:
        action2_destructive:
          name: "Option 2 – Destructive"
          default: false
          selector:
            boolean:

        action3_enabled:
          name: "Option 3 aktiv"
          default: false
          selector:
            boolean:
        action3_title:
          name: "Option 3 – Titel"
          default: "Stumm 1h"
          selector:
            text:
        action3_icon:
          name: "Option 3 – Icon (iOS)"
          default: ""
          selector:
            text:
        action3_destructive:
          name: "Option 3 – Destructive"
          default: false
          selector:
            boolean:

    # =======================
    # 9) SONSTIGES & COOLDOWNS
    # =======================
    misc_section:
      name: "Sonstiges & Cooldowns"
      description: "Diverse Einstellungen."
      icon: mdi:cog
      collapsed: true
      input:
        cooldown:
          name: "Global Cooldown"
          description: "Pausiert die Automation am Ende (unabhängig vom lokalen Throttle)."
          default: { seconds: 20 }
          selector:
            duration: {}

# ================= Variables =================
variables:
  # Inputs
  notify: !input notify
  delay_notification: !input delay_notification
  notification_time: !input notification_time
  tap_navigate: !input tap_navigate

  notification_sound: !input notification_sound
  notification_volume: !input notification_volume

  camera_entities_list: !input camera_entities
  motion_sensors_list: !input motion_sensors
  notify_devices: !input notify_device
  notify_groups_raw: !input notify_groups

  # AI inputs
  importance_enable: !input importance_enable
  importance_run_conditions: !input importance_run_conditions
  importance_prompt: !input importance_prompt

  importance_gate_enable: !input importance_gate_enable
  importance_gate_min_level: !input importance_gate_min_level
  importance_gate_conditions: !input importance_gate_conditions

  ai_force_on_critical: !input ai_force_on_critical

  ai_enable: !input ai_enable
  ai_run_conditions: !input ai_run_conditions
  provider: !input provider
  model: !input model
  ai_message: !input ai_message
  duration: !input duration
  max_frames: !input max_frames
  target_width: !input target_width
  max_tokens: !input max_tokens

  # TTS inputs
  tts_enable: !input tts_enable
  tts_target_entity: !input tts_target_entity
  tts_media_players: !input tts_media_players
  tts_volume: !input tts_volume
  tts_message: !input tts_message
  tts_repeat_count: !input tts_repeat_count
  tts_repeat_delay: !input tts_repeat_delay
  tts_conditions: !input tts_conditions

  # Storage inputs
  timestamp_filenames: !input timestamp_filenames
  timestamp_format: !input timestamp_format
  snapshot_dir_fs_base: !input snapshot_dir_fs
  snapshot_dir_web_base: !input snapshot_dir_web

  # Sonstiges
  cooldown: !input cooldown

  # Kamera aus Trigger ableiten (Sensor→Index→Kamera)
  camera_entity_snapshot: >
    {% if trigger is defined and trigger.entity_id %}
      {% set tid = trigger.entity_id %}
      {% if tid.startswith('binary_sensor') and (tid in motion_sensors_list) %}
        {% set i = motion_sensors_list.index(tid) %}
        {{ camera_entities_list[i] if camera_entities_list|length > i else (camera_entities_list[0] if camera_entities_list|length>0 else '') }}
      {% elif tid.startswith('camera.') %}
        {{ tid }}
      {% else %}
        {{ camera_entities_list[0] if camera_entities_list|length>0 else '' }}
      {% endif %}
    {% else %}
      {{ camera_entities_list[0] if camera_entities_list|length>0 else '' }}
    {% endif %}

  # Friendly Name + Pfade/Dateinamen
  camera_friendly: "{{ state_attr(camera_entity_snapshot, 'friendly_name') or 'Kamera' }}"
  camera_file_path: "{{ camera_friendly | slugify }}"
  snapshot_dir_fs_final: "{{ (snapshot_dir_fs_base.rstrip('/')) ~ '/' ~ camera_file_path }}"
  snapshot_dir_web_final: "{{ (snapshot_dir_web_base.rstrip('/')) ~ '/' ~ camera_file_path }}"
  snapshot_filename: "{{ (timestamp_filenames and now().strftime(timestamp_format) or 'last_motion') ~ '.jpg' }}"
  file_path: "{{ snapshot_dir_fs_final ~ '/' ~ snapshot_filename }}"
  snapshot_access_file_path: "{{ snapshot_dir_web_final ~ '/' ~ snapshot_filename }}"

  # Notification-Metadaten
  label: "Bewegung erkannt"
  camera: "{{ camera_friendly }}"
  notification_tag: "{{ camera_file_path ~ '_' ~ now().timestamp()|int }}"

  # Level-Ranking (für Gate-Threshold)
  level_rank: "{{ {'passive':0,'active':1,'time-sensitive':2,'critical':3} }}"

  # Robuste Liste gültiger mobile_app Notify-Services
  device_name_map: >
    {% set ns = namespace(device_names=[]) %}
    {% for dev in (notify_devices or []) %}
      {% set name = device_attr(dev, 'name') | default('', true) %}
      {% set slug = (name | slugify) | default('', true) %}
      {% if slug and (slug | length > 0) %}
        {% set ns.device_names = ns.device_names + ['mobile_app_' ~ slug] %}
      {% endif %}
    {% endfor %}
    {{ ns.device_names }}

  # Notify-Gruppen aus Textfeld (notify.xyz → nur Suffix als Service-Name)
  notify_group_services: >
    {% set raw = notify_groups_raw | default('', true) %}
    {% set parts = raw.split(',') if raw|length>0 else [] %}
    {% set cleaned = [] %}
    {% for p in parts %}
      {% set s = p|trim %}
      {% if s and s.startswith('notify.') and (s|length > 7) %}
        {% set cleaned = cleaned + [ s[7:] ] %}
      {% endif %}
    {% endfor %}
    {{ cleaned }}

  # Gesamte Ziel-Services (Geräte + Gruppen)
  notify_services_all: "{{ (device_name_map + notify_group_services) }}"

  # Action-Buttons als gemeinsame Liste
  notification_actions: >
    {% set actions = [] %}
    {% if action1_enabled | default(false) %}
      {% set _ = actions.append({
        'action': 'ACTION_1',
        'title': action1_title,
        'icon': action1_icon,
        'destructive': action1_destructive
      }) %}
    {% endif %}
    {% if action2_enabled | default(false) %}
      {% set _ = actions.append({
        'action': 'ACTION_2',
        'title': action2_title,
        'icon': action2_icon,
        'destructive': action2_destructive
      }) %}
    {% endif %}
    {% if action3_enabled | default(false) %}
      {% set _ = actions.append({
        'action': 'ACTION_3',
        'title': action3_title,
        'icon': action3_icon,
        'destructive': action3_destructive
      }) %}
    {% endif %}
    {{ actions }}

# ================= Meta =================
mode: queued
max: 25
max_exceeded: silent

# ================= Trigger =================
trigger:
  - platform: state
    entity_id: !input camera_entities
    to: !input trigger_state
    id: "camera_trigger"
  - platform: state
    entity_id: !input motion_sensors
    to: "on"
    id: "motion_sensor_trigger"

# ================= Actions =================
action:
  - if:
      - condition: template
        value_template: "{{ notify }}"
    then:
      - if:
          - condition: template
            value_template: >
              {{ not this.attributes.last_triggered
                 or (now() - this.attributes.last_triggered).seconds > delay_notification }}
        then:

          # 1) Snapshot
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ camera_entity_snapshot != '' }}"
                sequence:
                  - service: camera.snapshot
                    target:
                      entity_id: "{{ camera_entity_snapshot }}"
                    data:
                      filename: "{{ file_path }}"

          # 2) Wichtigkeits-Analyse (image_analyzer) – optional, nutzt Snapshot (file_path)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ importance_enable }}"
                  - condition: and
                    conditions: !input importance_run_conditions
                sequence:
                  - action: llmvision.image_analyzer
                    metadata: {}
                    data:
                      remember: true
                      image_file: "{{ file_path }}"
                      provider: !input provider
                      model: !input model
                      message: "{{ importance_prompt }}"
                      include_filename: true
                      target_width: !input target_width
                      max_tokens: !input max_tokens
                    response_variable: importance

          # 2b) Vorschlag normalisieren
          - variables:
              importance_suggested_level: >
                {% set fallback = 'time-sensitive' %}
                {% if importance is defined and importance.response_text %}
                  {% set t = importance.response_text | lower %}
                  {% if 'critical' in t %}critical
                  {% elif 'time-sensitive' in t or 'time sensitive' in t %}time-sensitive
                  {% elif 'active' in t %}active
                  {% elif 'passive' in t %}passive
                  {% else %}{{ fallback }}{% endif %}
                {% else %}{{ fallback }}{% endif %}

          # 2c) Endgültiges notification_level direkt aus Vorschlag
          - variables:
              notification_level: "{{ importance_suggested_level }}"

          # 3) Gate: Threshold + Zusatzbedingungen – stoppe, wenn Level unter Threshold
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ importance_gate_enable }}"
                  - condition: and
                    conditions: !input importance_gate_conditions
                  - condition: template
                    value_template: >
                      {{ (level_rank[notification_level]|default(-1)) < (level_rank[importance_gate_min_level]|default(0)) }}
                sequence:
                  - stop: "Gate aktiv: Level '{{ notification_level }}' < Threshold '{{ importance_gate_min_level }}'."

          # 3) Erste Push (mit dynamischem Level & Actions)
          - alias: "Notify initial (iOS, Tag, dynamic level)"
            repeat:
              for_each: "{{ notify_services_all }}"
              sequence:
                - variables:
                    current_notify_service: "{{ repeat.item }}"
                - service: "notify.{{ current_notify_service }}"
                  data:
                    title: "{{ camera }} - {{ label }} {{ notification_time }}"
                    message: "Bewegung erkannt ({{ notification_level }})."
                    data:
                      url: !input tap_navigate
                      clickAction: !input tap_navigate
                      tag: "{{ notification_tag }}"
                      group: "cams"
                      attachment:
                        url: "{{ snapshot_access_file_path }}"
                        content_type: JPEG
                      actions: "{{ notification_actions }}"
                      push:
                        interruption-level: "{{ notification_level }}"
                        sound:
                          name: "{{ notification_sound }}"
                          volume: "{{ notification_volume }}"
                          critical: "{{ notification_level == 'critical' }}"

          # 3b) TTS nach erster Push, nur bei 'critical'
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ tts_enable }}"
                  - condition: template
                    value_template: "{{ notification_level == 'critical' }}"
                  - condition: and
                    conditions: !input tts_conditions
                  - condition: template
                    value_template: >
                      {{ (tts_media_players | length) > 0 and tts_target_entity is not none and tts_target_entity != '' }}
                sequence:
                  - repeat:
                      count: "{{ tts_repeat_count }}"
                      sequence:
                        - delay: !input tts_repeat_delay
                        - repeat:
                            for_each: "{{ tts_media_players }}"
                            sequence:
                              - service: media_player.volume_set
                                target:
                                  entity_id: "{{ repeat.item }}"
                                data:
                                  volume_level: "{{ tts_volume }}"
                              - service: tts.speak
                                target:
                                  entity_id: "{{ tts_target_entity }}"
                                data:
                                  cache: false
                                  media_player_entity_id: "{{ repeat.item }}"
                                  message: "{{ tts_message }}"

          # 3c) Alarm-Wiederholungen (eigener Tag je Wiederholung, gleicher Inhalt, gleicher Ton)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ alarm_repetition_enable }}"
                  - condition: template
                    value_template: "{{ notification_level in ['time-sensitive','critical'] }}"
                  - condition: and
                    conditions: !input alarm_repetition_conditions
                sequence:
                  - alias: "Alarm-Wiederholungen (alle Notify-Services)"
                    repeat:
                      for_each: "{{ notify_services_all }}"
                      sequence:
                        - variables:
                            alarm_notify_service: "{{ repeat.item }}"
                        - repeat:
                            count: "{{ alarm_repetition_count }}"
                            sequence:
                              - delay: !input alarm_repetition_delay
                              - service: "notify.{{ alarm_notify_service }}"
                                data:
                                  title: "{{ camera }} - {{ label }} {{ notification_time }}"
                                  message: "Bewegung erkannt ({{ notification_level }})."
                                  data:
                                    url: !input tap_navigate
                                    clickAction: !input tap_navigate
                                    tag: "{{ notification_tag ~ '_alarm_' ~ repeat.index }}"
                                    group: "cams"
                                    attachment:
                                      url: "{{ snapshot_access_file_path }}"
                                      content_type: JPEG
                                    actions: "{{ notification_actions }}"
                                    push:
                                      interruption-level: "{{ notification_level }}"
                                      sound:
                                        name: "{{ notification_sound }}"
                                        volume: "{{ notification_volume }}"
                                        critical: "{{ notification_level == 'critical' }}"

          # 4) AI-Stream-Analyse (einmalig): erzwungen bei 'critical' ODER normal via ai_enable+conditions
          - choose:
              - conditions:
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ ai_force_on_critical }}"
                          - condition: template
                            value_template: "{{ notification_level == 'critical' }}"
                          - condition: template
                            value_template: "{{ camera_entity_snapshot != '' }}"
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ ai_enable }}"
                          - condition: and
                            conditions: !input ai_run_conditions
                          - condition: template
                            value_template: "{{ camera_entity_snapshot != '' }}"
                sequence:
                  - action: llmvision.stream_analyzer
                    metadata: {}
                    data:
                      remember: true
                      image_entity:
                        - "{{ camera_entity_snapshot }}"
                      duration: !input duration
                      provider: !input provider
                      model: !input model
                      message: "{{ ai_message }}"
                      include_filename: true
                      max_frames: !input max_frames
                      target_width: !input target_width
                      max_tokens: !input max_tokens
                    response_variable: response

          # 5) Update-Push (falls Stream-Analyse gelaufen ist)
          - if:
              - condition: template
                value_template: "{{ response is defined and response.response_text is defined }}"
            then:
              - alias: "Notify update (same Tag, Analyzer Response, dynamic level)"
                repeat:
                  for_each: "{{ notify_services_all }}"
                  sequence:
                    - variables:
                        current_notify_service: "{{ repeat.item }}"
                    - service: "notify.{{ current_notify_service }}"
                      data:
                        title: "{{ camera }} - {{ label }} {{ notification_time }}"
                        message: "{{ response.response_text }} ({{ notification_level }})"
                        data:
                          url: !input tap_navigate
                          clickAction: !input tap_navigate
                          tag: "{{ notification_tag }}"
                          group: "cams"
                          attachment:
                            url: "{{ snapshot_access_file_path }}"
                            content_type: JPEG
                          actions: "{{ notification_actions }}"
                          push:
                            interruption-level: "{{ notification_level }}"
                            sound:
                              name: "{{ notification_sound }}"
                              volume: "{{ notification_volume }}"
                              critical: "{{ notification_level == 'critical' }}"

  # 6) Globaler Cooldown
  - delay: !input cooldown
